<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bronco Braves â€” 1st & 3rd Defense Rotations</title>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #1a1c20; --surface: #23262b; --surface2: #2c3038;
  --border: #383c44; --text: #e8e9eb; --text-dim: #8b909a;
  --accent: #0057b8; --accent-light: #3d8fdb; --accent-glow: rgba(0,87,184,0.25);
  --green: #2ea043; --green-dim: rgba(46,160,67,0.15);
  --red: #cf3d3d; --red-dim: rgba(207,61,61,0.15);
  --yellow: #d4a017; --yellow-dim: rgba(212,160,23,0.15);
  --orange: #e07020; --gold: #d4a843;
  --purple: #9b59b6; --purple-dim: rgba(155,89,182,0.15);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Source Sans 3',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

.header { background:linear-gradient(135deg,#0d0e10,#1a1c20); border-bottom:2px solid var(--accent); padding:12px 24px; display:flex; align-items:center; gap:16px; position:sticky; top:0; z-index:100; }
.header h1 { font-family:'Oswald',sans-serif; font-weight:700; font-size:20px; text-transform:uppercase; letter-spacing:2px; white-space:nowrap; }
.header h1 span { color:var(--accent-light); }
.header-actions { margin-left:auto; display:flex; gap:8px; flex-shrink:0; flex-wrap:wrap; }

.btn { font-family:'Oswald',sans-serif; font-weight:500; font-size:12px; text-transform:uppercase; letter-spacing:1.5px; padding:7px 14px; border:1px solid var(--border); border-radius:4px; background:var(--surface2); color:var(--text); cursor:pointer; transition:all 0.15s; white-space:nowrap; }
.btn:hover { border-color:var(--accent); background:var(--accent-glow); }
.btn.primary { background:var(--accent); border-color:var(--accent); }
.btn.primary:hover { background:var(--accent-light); }
.btn.danger { border-color:var(--red); color:var(--red); }
.btn.danger:hover { background:var(--red-dim); }

.rotation-tabs-bar { background:var(--surface); border-bottom:1px solid var(--border); padding:0 24px; display:flex; align-items:stretch; overflow-x:auto; }
.rot-tab { font-family:'Oswald',sans-serif; font-weight:500; font-size:13px; text-transform:uppercase; letter-spacing:1.5px; padding:10px 20px; border:none; background:transparent; color:var(--text-dim); cursor:pointer; border-bottom:3px solid transparent; transition:all 0.15s; white-space:nowrap; display:flex; align-items:center; gap:8px; }
.rot-tab:hover { color:var(--text); background:rgba(255,255,255,0.03); }
.rot-tab.active { color:var(--accent-light); border-bottom-color:var(--accent); }
.rot-tab .tab-count { font-size:10px; font-weight:700; padding:1px 6px; border-radius:8px; background:var(--surface2); color:var(--text-dim); }
.rot-tab.active .tab-count { background:var(--accent-glow); color:var(--accent-light); }
.add-rot-btn { font-family:'Oswald',sans-serif; font-weight:500; font-size:18px; padding:8px 16px; border:none; background:transparent; color:var(--text-dim); cursor:pointer; }
.add-rot-btn:hover { color:var(--accent-light); }

.rot-name-bar { padding:8px 24px; display:flex; align-items:center; gap:10px; background:var(--bg); border-bottom:1px solid var(--border); }
.rot-name-input { font-family:'Oswald',sans-serif; font-weight:600; font-size:16px; text-transform:uppercase; letter-spacing:1px; background:transparent; border:none; border-bottom:1px dashed var(--border); color:var(--gold); padding:4px 0; outline:none; width:300px; }
.rot-name-input:focus { border-bottom-color:var(--accent); }
.rot-name-bar .player-count { font-size:11px; color:var(--text-dim); font-weight:600; }
.rot-name-bar .delete-rot { margin-left:auto; font-family:'Oswald',sans-serif; font-size:11px; text-transform:uppercase; letter-spacing:1px; padding:5px 12px; border-radius:4px; border:1px solid var(--red); background:transparent; color:var(--red); cursor:pointer; }
.rot-name-bar .delete-rot:hover { background:var(--red-dim); }

.attendance-bar { background:var(--surface); border-bottom:1px solid var(--border); padding:8px 24px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.attendance-label { font-family:'Oswald',sans-serif; font-weight:600; font-size:11px; text-transform:uppercase; letter-spacing:1.5px; color:var(--text-dim); margin-right:6px; }
.att-player { display:flex; align-items:center; gap:4px; padding:3px 8px 3px 4px; border-radius:4px; background:var(--surface2); border:1px solid var(--border); cursor:pointer; transition:all 0.12s; user-select:none; }
.att-player:hover { border-color:var(--accent); }
.att-player.absent { opacity:0.35; border-color:transparent; }
.att-player input[type="checkbox"] { width:13px; height:13px; accent-color:var(--accent); cursor:pointer; }
.att-name { font-size:11px; font-weight:600; white-space:nowrap; }

.main-layout { display:flex; min-height:calc(100vh - 160px); }
.grid-area { flex:1; padding:12px 16px; overflow-x:auto; }

.rotation-table { width:100%; min-width:600px; border-collapse:separate; border-spacing:2px; }
.rotation-table th { font-family:'Oswald',sans-serif; font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing:1.5px; color:var(--text-dim); padding:8px 6px; background:var(--surface); border-radius:4px 4px 0 0; }
.rotation-table th.pos-col { width:155px; text-align:left; padding-left:10px; }
.rotation-table th.rot-col { text-align:center; }

.rotation-table td { background:var(--surface); border-radius:3px; min-height:38px; padding:3px; vertical-align:top; position:relative; }
.rotation-table td.pos-cell { font-family:'Oswald',sans-serif; font-weight:500; font-size:12px; text-transform:uppercase; letter-spacing:1px; color:var(--text-dim); padding:6px 10px; background:var(--surface2); white-space:nowrap; vertical-align:middle; }
.rotation-table td.pos-cell.bench-cell { color:var(--yellow); font-style:italic; }
.rotation-table td.pos-cell.runner-cell { color:var(--green); }
tr.section-sep td { height:4px; background:transparent; padding:0; border:none; }

.cell-content { display:flex; flex-direction:column; gap:2px; min-height:32px; }

.player-chip { font-family:'Source Sans 3',sans-serif; font-weight:600; font-size:11px; padding:3px 24px 3px 6px; border-radius:3px; background:var(--accent-glow); border:1px solid var(--accent); color:var(--text); white-space:nowrap; position:relative; overflow:hidden; text-overflow:ellipsis; }
.player-chip .remove-chip { position:absolute; right:2px; top:50%; transform:translateY(-50%); font-size:10px; cursor:pointer; opacity:0.4; width:16px; height:16px; display:flex; align-items:center; justify-content:center; border-radius:3px; }
.player-chip .remove-chip:hover { opacity:1; background:rgba(207,61,61,0.3); color:var(--red); }
.player-chip.top-pick { border-color:var(--green); background:var(--green-dim); }
.player-chip.mid-pick { border-color:var(--yellow); background:var(--yellow-dim); }
.player-chip.low-pick { border-color:var(--orange); background:rgba(224,112,32,0.15); }

.coach-chip { font-family:'Source Sans 3',sans-serif; font-weight:600; font-size:11px; padding:3px 24px 3px 6px; border-radius:3px; background:var(--purple-dim); border:1px solid var(--purple); color:#c9a6e0; white-space:nowrap; position:relative; display:flex; align-items:center; gap:4px; }
.coach-chip .remove-chip { position:absolute; right:2px; top:50%; transform:translateY(-50%); font-size:10px; cursor:pointer; opacity:0.4; width:16px; height:16px; display:flex; align-items:center; justify-content:center; border-radius:3px; }
.coach-chip .remove-chip:hover { opacity:1; background:rgba(207,61,61,0.3); color:var(--red); }
.coach-name-inline { background:transparent; border:none; border-bottom:1px dashed rgba(155,89,182,0.4); color:#c9a6e0; font-family:'Source Sans 3',sans-serif; font-size:10px; font-weight:600; width:80px; outline:none; padding:0 2px; }
.coach-name-inline::placeholder { color:rgba(155,89,182,0.4); }
.coach-name-inline:focus { border-bottom-color:var(--purple); }

.cell-add-row { display:flex; gap:3px; margin-top:2px; }
.add-btn { font-family:'Oswald',sans-serif; font-size:9px; font-weight:500; text-transform:uppercase; letter-spacing:0.8px; padding:2px 6px; border-radius:3px; border:1px dashed var(--border); background:transparent; color:var(--text-dim); cursor:pointer; transition:all 0.12s; }
.add-btn:hover { border-color:var(--accent); color:var(--accent-light); background:var(--accent-glow); }
.add-btn.coach-add:hover { border-color:var(--purple); color:var(--purple); background:var(--purple-dim); }

.add-dropdown { position:absolute; z-index:50; background:var(--surface2); border:1px solid var(--border); border-radius:4px; padding:4px 0; max-height:200px; overflow-y:auto; min-width:140px; box-shadow:0 8px 24px rgba(0,0,0,0.5); }
.add-dropdown-item { padding:5px 10px; font-size:11px; font-weight:600; cursor:pointer; transition:background 0.1s; white-space:nowrap; }
.add-dropdown-item:hover { background:var(--accent-glow); color:var(--accent-light); }

.validation-panel { width:240px; min-width:240px; background:var(--surface); border-left:1px solid var(--border); display:flex; flex-direction:column; overflow-y:auto; }
.panel-title { font-family:'Oswald',sans-serif; font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing:2px; color:var(--text-dim); padding:12px 14px 8px; border-bottom:1px solid var(--border); }
.validation-list { flex:1; overflow-y:auto; padding:6px; }
.v-item { font-size:11px; padding:5px 8px; margin-bottom:2px; border-radius:3px; display:flex; align-items:flex-start; gap:5px; line-height:1.35; }
.v-item.error { background:var(--red-dim); color:var(--red); }
.v-item.warn { background:var(--yellow-dim); color:var(--yellow); }
.v-item.ok { background:var(--green-dim); color:var(--green); }
.v-icon { font-size:12px; flex-shrink:0; }
.suggest-section { padding:8px; border-top:1px solid var(--border); }
.suggest-section .btn { width:100%; text-align:center; margin-bottom:4px; }

/* Coaches Bar */
.coaches-bar {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 10px 24px; display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-start;
}

.coaches-bar-label {
  font-family: 'Oswald', sans-serif; font-weight: 600; font-size: 11px;
  text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim);
  margin-right: 4px; padding-top: 7px; white-space: nowrap;
}

.coach-card {
  display: flex; flex-direction: column; gap: 3px;
  padding: 6px 10px; border-radius: 6px;
  background: var(--surface2); border: 1px solid var(--border);
  min-width: 155px; transition: all 0.12s;
}

.coach-card.optional { border-style: dashed; }
.coach-card.optional.inactive { opacity: 0.35; cursor: pointer; }
.coach-card.optional.inactive:hover { opacity: 0.6; border-color: var(--accent); }

.coach-card-role {
  font-family: 'Oswald', sans-serif; font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 1px; color: var(--purple);
  display: flex; align-items: center; gap: 6px;
}

.coach-card-role .opt-tag {
  font-size: 8px; font-weight: 700; padding: 1px 5px;
  border-radius: 3px; background: var(--purple-dim); color: var(--purple);
  letter-spacing: 0.5px;
}

.coach-card-role .remove-coach-card {
  margin-left: auto; font-size: 10px; cursor: pointer; opacity: 0.4;
  color: var(--red);
}

.coach-card-role .remove-coach-card:hover { opacity: 1; }

.coach-card-name {
  background: transparent; border: none; border-bottom: 1px dashed rgba(155,89,182,0.3);
  color: var(--text); font-family: 'Source Sans 3', sans-serif;
  font-size: 12px; font-weight: 600; width: 100%; outline: none; padding: 2px 0;
}

.coach-card-name::placeholder { color: var(--text-dim); font-weight: 500; }
.coach-card-name:focus { border-bottom-color: var(--purple); }

@media (max-width:1100px) { .validation-panel { width:200px; min-width:200px; } }
</style>
</head>
<body>

<div class="header">
  <h1>Bronco Braves <span>1st &amp; 3rd Defense</span></h1>
  <div class="header-actions">
    <button class="btn" onclick="removeRotationCol()">âˆ’ Rotation</button>
    <button class="btn" onclick="addRotationCol()">+ Rotation</button>
    <button class="btn primary" onclick="autoFill()">âš¡ Auto-Fill</button>
    <button class="btn" onclick="exportPrint()">ðŸ“„ Print</button>
    <button class="btn danger" onclick="clearAll()">âœ• Clear</button>
  </div>
</div>

<div class="rotation-tabs-bar" id="rotTabsBar"></div>
<div class="rot-name-bar" id="rotNameBar"></div>
<div class="attendance-bar" id="attendanceBar"></div>

<div class="coaches-bar" id="coachesBar"></div>

<div class="main-layout">
  <div class="grid-area">
    <table class="rotation-table" id="rotationTable"></table>
  </div>
  <div class="validation-panel">
    <div class="panel-title">Validation</div>
    <div class="validation-list" id="validationList"></div>
    <div class="suggest-section">
      <button class="btn primary" onclick="autoFill()">âš¡ Auto-Fill All</button>
    </div>
  </div>
</div>

<script>
const PLAYERS = [
  "J. Reinhardt","H. Reinhardt","B. Cox","R. Sullivan",
  "G. Williams","C. Coleman","M. Cage","M. Warren",
  "L. Fraser","N. Crosby","G. Sprague","F. Butler"
];

const POSITIONS = [
  { key:"P", label:"Pitcher", abbrev:"P", type:"defense" },
  { key:"C", label:"Catcher", abbrev:"C", type:"defense" },
  { key:"SS", label:"Shortstop", abbrev:"SS", type:"defense" },
  { key:"3B", label:"Third Base", abbrev:"3B", type:"defense" },
  { key:"2B", label:"Second Base", abbrev:"2B", type:"defense" },
  { key:"1B", label:"First Base", abbrev:"1B", type:"defense" },
  { key:"BN", label:"Bench", abbrev:"BN", type:"bench" },
  { key:"R1", label:"Runner â€” 1st Base", abbrev:"R1", type:"runner" },
  { key:"R3", label:"Runner â€” 3rd Base", abbrev:"R3", type:"runner" },
];

function basePosKey(key) {
  return {P:"Pitcher",C:"Catcher",SS:"Shortstop","3B":"Third Base","2B":"Second Base","1B":"First Base"}[key]||null;
}

const PROFICIENCY = {
  "Pitcher":["J. Reinhardt","B. Cox","R. Sullivan","M. Cage","N. Crosby","G. Sprague","G. Williams","C. Coleman"],
  "Catcher":["B. Cox","R. Sullivan","C. Coleman","N. Crosby","G. Sprague"],
  "First Base":["R. Sullivan","B. Cox","L. Fraser","C. Coleman","N. Crosby"],
  "Second Base":["G. Williams","J. Reinhardt","F. Butler","C. Coleman","M. Warren","M. Cage"],
  "Third Base":["M. Cage","J. Reinhardt","R. Sullivan","L. Fraser","N. Crosby","H. Reinhardt","G. Sprague","B. Cox","C. Coleman"],
  "Shortstop":["M. Cage","F. Butler","J. Reinhardt","R. Sullivan","G. Williams"]
};

const PLAYER_POSITIONS = {
  "J. Reinhardt":["Pitcher","Third Base","Second Base","Shortstop"],
  "H. Reinhardt":["Pitcher","Third Base"],
  "B. Cox":["Catcher","Pitcher","First Base","Third Base"],
  "R. Sullivan":["First Base","Catcher","Pitcher","Third Base","Shortstop","Second Base"],
  "G. Williams":["Second Base","Shortstop","Pitcher","Third Base"],
  "C. Coleman":["Catcher","Second Base","First Base","Third Base","Pitcher"],
  "M. Cage":["Shortstop","Third Base","Pitcher","Second Base"],
  "M. Warren":["Second Base"],
  "L. Fraser":["Third Base","First Base"],
  "N. Crosby":["Third Base","Pitcher","Catcher","First Base"],
  "G. Sprague":["Third Base","Catcher","Pitcher"],
  "F. Butler":["Shortstop","Second Base"]
};

const DRILL_COACHES = [
  { key: "3bcoach", role: "3rd Base Coach", desc: "Helping runners from 3rd", required: true },
  { key: "1bcoach", role: "1st Base Coach", desc: "Helping runners from 1st", required: true },
  { key: "signs", role: "Giving Signs", desc: "Calling the play for defense", required: true },
  { key: "catching", role: "Catcher Coach", desc: "Helping catchers with reads & throws", required: false },
  { key: "middle", role: "Middle Infield Coach", desc: "Helping SS/2B with coverage", required: false },
];

let drillCoachNames = {};
let drillCoachEnabled = {};
DRILL_COACHES.forEach(c => { drillCoachNames[c.key] = ''; drillCoachEnabled[c.key] = c.required; });

const DEFAULT_ROTATIONS = 4;

let presets = [{ name:"Full Squad (12)", absent:new Set(), numRot:DEFAULT_ROTATIONS, grid:makeEmptyGrid(DEFAULT_ROTATIONS) }];
let activePreset = 0;
let openDropdown = null;

function makeEmptyGrid(n) {
  const g = [];
  for (let i=0;i<n;i++) { g[i]={}; POSITIONS.forEach(p=>g[i][p.key]={players:[],coaches:[]}); }
  return g;
}

function cur() { return presets[activePreset]; }
function numRot() { return cur().numRot; }
function getActivePlayers() { return PLAYERS.filter(p=>!cur().absent.has(p)); }

function getAssignedInRotation(rot) {
  const s=new Set(); POSITIONS.forEach(p=>cur().grid[rot][p.key].players.forEach(pl=>s.add(pl))); return s;
}
function getAvailableForRotation(rot) { const a=getAssignedInRotation(rot); return getActivePlayers().filter(p=>!a.has(p)); }

function canPlay(player,posKey) { if(posKey==="BN"||posKey==="R1"||posKey==="R3") return true; const bp=basePosKey(posKey); return bp?PLAYER_POSITIONS[player]?.includes(bp):true; }
function getProfRank(player,posKey) { const bp=basePosKey(posKey); if(!bp) return null; const l=PROFICIENCY[bp]; if(!l) return null; const i=l.indexOf(player); return i>=0?i+1:null; }
function getRankClass(rank,posKey) { if(!rank) return ""; const bp=basePosKey(posKey); if(!bp) return ""; const t=PROFICIENCY[bp]?.length||12; if(rank<=2) return "top-pick"; if(rank/t<=0.33) return "top-pick"; if(rank/t<=0.66) return "mid-pick"; return "low-pick"; }

function addPreset() { const nr=numRot(); presets.push({name:`Preset ${presets.length+1}`,absent:new Set(cur().absent),numRot:nr,grid:makeEmptyGrid(nr)}); activePreset=presets.length-1; render(); }
function deletePreset() { if(presets.length<=1)return; presets.splice(activePreset,1); activePreset=Math.min(activePreset,presets.length-1); render(); }
function switchPreset(idx) { activePreset=idx; render(); }
function addRotationCol() { const p=cur(); p.numRot++; p.grid.push({}); POSITIONS.forEach(pos=>p.grid[p.numRot-1][pos.key]={players:[],coaches:[]}); render(); }
function removeRotationCol() { if(cur().numRot<=1)return; cur().numRot--; cur().grid.pop(); render(); }

function addPlayerToCell(rot,posKey,player) { const g=cur().grid; POSITIONS.forEach(p=>{g[rot][p.key].players=g[rot][p.key].players.filter(pl=>pl!==player);}); g[rot][posKey].players.push(player); openDropdown=null; render(); }
function removePlayerFromCell(rot,posKey,player) { cur().grid[rot][posKey].players=cur().grid[rot][posKey].players.filter(p=>p!==player); render(); }
function addCoachToCell(rot,posKey) { cur().grid[rot][posKey].coaches.push({name:''}); openDropdown=null; render(); }
function updateCoachName(rot,posKey,idx,value) { cur().grid[rot][posKey].coaches[idx].name=value; }
function removeCoachFromCell(rot,posKey,idx) { cur().grid[rot][posKey].coaches.splice(idx,1); render(); }
function toggleDropdown(rot,posKey) { if(openDropdown&&openDropdown.rot===rot&&openDropdown.posKey===posKey) openDropdown=null; else openDropdown={rot,posKey}; render(); }

function clearAll() { const g=cur().grid; for(let i=0;i<numRot();i++) POSITIONS.forEach(p=>{g[i][p.key]={players:[],coaches:[]};}); render(); }

function autoFill() {
  clearAll();
  const ap=getActivePlayers(), g=cur().grid;
  const defPos=POSITIONS.filter(p=>p.type==='defense');
  for(let i=0;i<numRot();i++) {
    const assigned=new Set(), prev={};
    if(i>0) POSITIONS.forEach(pos=>g[i-1][pos.key].players.forEach(pl=>prev[pl]=pos.key));
    const posByScar=[...defPos].sort((a,b)=>ap.filter(p=>!assigned.has(p)&&canPlay(p,a.key)).length-ap.filter(p=>!assigned.has(p)&&canPlay(p,b.key)).length);
    for(const pos of posByScar) {
      const el=ap.filter(p=>!assigned.has(p)&&canPlay(p,pos.key)).sort((a,b)=>(getProfRank(a,pos.key)||99)+(prev[a]===pos.key?3:0)-((getProfRank(b,pos.key)||99)+(prev[b]===pos.key?3:0)));
      if(el.length>0){g[i][pos.key].players.push(el[0]);assigned.add(el[0]);}
    }
    const rem=ap.filter(p=>!assigned.has(p));
    const half=Math.ceil(rem.length/2);
    rem.slice(0,half).forEach(p=>g[i]["R1"].players.push(p));
    rem.slice(half).forEach(p=>g[i]["R3"].players.push(p));
  }
  render();
}

function render() { renderTabs(); renderNameBar(); renderAttendance(); renderCoaches(); renderTable(); renderValidation(); }

function renderTabs() {
  const bar=document.getElementById('rotTabsBar'); bar.innerHTML='';
  presets.forEach((p,idx)=>{const btn=document.createElement('button');btn.className='rot-tab'+(idx===activePreset?' active':'');btn.innerHTML=`${p.name} <span class="tab-count">${PLAYERS.filter(pl=>!p.absent.has(pl)).length}</span>`;btn.onclick=()=>switchPreset(idx);bar.appendChild(btn);});
  const ab=document.createElement('button');ab.className='add-rot-btn';ab.textContent='+';ab.onclick=addPreset;bar.appendChild(ab);
}

function renderNameBar() {
  const bar=document.getElementById('rotNameBar'),ap=getActivePlayers();
  bar.innerHTML=`<input class="rot-name-input" value="${cur().name}" oninput="cur().name=this.value;renderTabs();"><span class="player-count">${ap.length} of ${PLAYERS.length} players Â· ${numRot()} rotations</span>${presets.length>1?'<button class="delete-rot" onclick="deletePreset()">âœ• Delete Preset</button>':''}`;
}

function renderAttendance() {
  const el=document.getElementById('attendanceBar'); el.innerHTML='<span class="attendance-label">Attendance</span>';
  PLAYERS.forEach(player=>{
    const isAbsent=cur().absent.has(player);
    const div=document.createElement('div');div.className='att-player'+(isAbsent?' absent':'');
    div.innerHTML=`<input type="checkbox" ${isAbsent?'':'checked'}><span class="att-name">${player}</span>`;
    div.querySelector('input').addEventListener('change',e=>{
      if(!e.target.checked){cur().absent.add(player);const g=cur().grid;for(let i=0;i<numRot();i++)POSITIONS.forEach(p=>{g[i][p.key].players=g[i][p.key].players.filter(pl=>pl!==player);});}
      else cur().absent.delete(player);
      render();
    });
    el.appendChild(div);
  });
}

function renderCoaches() {
  const el = document.getElementById('coachesBar');
  el.innerHTML = '<span class="coaches-bar-label">ðŸ§¢ Coaches</span>';

  DRILL_COACHES.forEach(c => {
    const enabled = drillCoachEnabled[c.key];
    const card = document.createElement('div');

    if (!enabled) {
      card.className = 'coach-card optional inactive';
      card.innerHTML = `
        <div class="coach-card-role">${c.role} <span class="opt-tag">Optional</span></div>
      `;
      card.onclick = () => { drillCoachEnabled[c.key] = true; render(); };
    } else {
      card.className = 'coach-card' + (c.required ? '' : ' optional');
      const removeBtn = c.required ? '' : `<span class="remove-coach-card" onclick="event.stopPropagation();drillCoachEnabled['${c.key}']=false;drillCoachNames['${c.key}']='';render();">âœ•</span>`;
      card.innerHTML = `
        <div class="coach-card-role">${c.role}${c.required ? '' : ' <span class="opt-tag">Optional</span>'}${removeBtn}</div>
        <input type="text" class="coach-card-name" placeholder="${c.desc}" value="${drillCoachNames[c.key]}"
          oninput="drillCoachNames['${c.key}']=this.value" onclick="event.stopPropagation()">
      `;
    }
    el.appendChild(card);
  });
}

function renderTable() {
  const table=document.getElementById('rotationTable'); table.innerHTML='';
  const g=cur().grid;

  const thead=document.createElement('thead'),hr=document.createElement('tr');
  const thP=document.createElement('th');thP.className='pos-col';thP.textContent='Position';hr.appendChild(thP);
  for(let i=0;i<numRot();i++){const th=document.createElement('th');th.className='rot-col';th.textContent=`Rotation ${i+1}`;hr.appendChild(th);}
  thead.appendChild(hr);table.appendChild(thead);

  const tbody=document.createElement('tbody');
  let lastType=null;

  POSITIONS.forEach(pos=>{
    if(lastType&&lastType!==pos.type){const sep=document.createElement('tr');sep.className='section-sep';for(let c=0;c<=numRot();c++)sep.appendChild(document.createElement('td'));tbody.appendChild(sep);}
    lastType=pos.type;

    const tr=document.createElement('tr');
    const tdL=document.createElement('td');
    tdL.className='pos-cell'+(pos.type==='bench'?' bench-cell':'')+(pos.type==='runner'?' runner-cell':'');
    tdL.textContent=`${pos.abbrev}  ${pos.label}`;
    tr.appendChild(tdL);

    for(let i=0;i<numRot();i++){
      const td=document.createElement('td');td.style.position='relative';
      const cell=g[i][pos.key];
      const content=document.createElement('div');content.className='cell-content';

      cell.players.forEach(player=>{
        const rank=getProfRank(player,pos.key),rc=getRankClass(rank,pos.key);
        const chip=document.createElement('div');chip.className=`player-chip ${rc}`;
        chip.innerHTML=`${player}${rank?` <span style="font-size:8px;opacity:0.6;">#${rank}</span>`:''}<span class="remove-chip" onclick="removePlayerFromCell(${i},'${pos.key}','${player}')">âœ•</span>`;
        content.appendChild(chip);
      });

      cell.coaches.forEach((coach,cIdx)=>{
        const chip=document.createElement('div');chip.className='coach-chip';
        chip.innerHTML=`ðŸ§¢ <input type="text" class="coach-name-inline" placeholder="Name..." value="${coach.name}" oninput="updateCoachName(${i},'${pos.key}',${cIdx},this.value)" onclick="event.stopPropagation()"><span class="remove-chip" onclick="removeCoachFromCell(${i},'${pos.key}',${cIdx})">âœ•</span>`;
        content.appendChild(chip);
      });

      const addRow=document.createElement('div');addRow.className='cell-add-row';
      const apb=document.createElement('button');apb.className='add-btn';apb.textContent='+ Player';apb.onclick=e=>{e.stopPropagation();toggleDropdown(i,pos.key);};addRow.appendChild(apb);
      const acb=document.createElement('button');acb.className='add-btn coach-add';acb.textContent='+ Coach';acb.onclick=e=>{e.stopPropagation();addCoachToCell(i,pos.key);};addRow.appendChild(acb);
      content.appendChild(addRow);

      if(openDropdown&&openDropdown.rot===i&&openDropdown.posKey===pos.key){
        const dd=document.createElement('div');dd.className='add-dropdown';
        const avail=getAvailableForRotation(i);
        if(!avail.length){dd.innerHTML='<div style="padding:8px;font-size:10px;color:var(--text-dim);text-align:center;">All assigned</div>';}
        else{
          [...avail].sort((a,b)=>{const ca=canPlay(a,pos.key)?0:1,cb=canPlay(b,pos.key)?0:1;if(ca!==cb)return ca-cb;return(getProfRank(a,pos.key)||99)-(getProfRank(b,pos.key)||99);})
          .forEach(player=>{
            const item=document.createElement('div');item.className='add-dropdown-item';
            const rank=getProfRank(player,pos.key);
            item.textContent=player+(rank?` (#${rank})`:'');
            if(!canPlay(player,pos.key)&&pos.type==='defense') item.style.opacity='0.4';
            item.onclick=e=>{e.stopPropagation();addPlayerToCell(i,pos.key,player);};
            dd.appendChild(item);
          });
        }
        content.appendChild(dd);
      }
      td.appendChild(content);tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
}

function renderValidation() {
  const el=document.getElementById('validationList');el.innerHTML='';
  const ap=getActivePlayers(),g=cur().grid;
  const sh=document.createElement('div');sh.style.cssText='font-family:Oswald;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);padding:6px 4px 4px;';sh.textContent='Player Coverage';el.appendChild(sh);
  ap.forEach(player=>{
    let rots=0;for(let i=0;i<numRot();i++)if(POSITIONS.some(p=>g[i][p.key].players.includes(player)))rots++;
    const status=rots===numRot()?'ok':'warn';
    let msg=`${player}: ${rots}/${numRot()}`;if(rots===0)msg+=' (unassigned)';
    const item=document.createElement('div');item.className=`v-item ${status}`;item.innerHTML=`<span class="v-icon">${status==='ok'?'âœ“':'!'}</span><span>${msg}</span>`;el.appendChild(item);
  });
  const issues=[];
  for(let i=0;i<numRot();i++){const seen={};POSITIONS.forEach(p=>{g[i][p.key].players.forEach(pl=>{if(seen[pl])issues.push({type:'error',msg:`${pl} appears twice in rotation ${i+1}`});seen[pl]=true;});});}
  if(issues.length>0){const ih=document.createElement('div');ih.style.cssText='font-family:Oswald;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);padding:10px 4px 4px;';ih.textContent='Issues';el.appendChild(ih);issues.forEach(issue=>{const item=document.createElement('div');item.className=`v-item ${issue.type}`;item.innerHTML=`<span class="v-icon">âœ•</span><span>${issue.msg}</span>`;el.appendChild(item);});}
}

document.addEventListener('click',()=>{if(openDropdown){openDropdown=null;render();}});

function exportPrint() {
  const g=cur().grid,ap=getActivePlayers();
  const today=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

  let headerCells='<th style="padding:6px 8px;text-align:left;font-size:9px;color:#fff;background:#0057b8;">POSITION</th>';
  for(let i=0;i<numRot();i++) headerCells+=`<th style="padding:6px 8px;text-align:center;font-size:9px;color:#fff;background:#0057b8;">ROT ${i+1}</th>`;

  let lastType=null,tableRows='';
  POSITIONS.forEach((pos,rowIdx)=>{
    if(lastType&&lastType!==pos.type) tableRows+=`<tr><td colspan="${numRot()+1}" style="height:4px;border:none;background:transparent;"></td></tr>`;
    lastType=pos.type;
    const rowBg=pos.type==='bench'?'#fffcf0':pos.type==='runner'?'#f0fff4':(rowIdx%2===0?'#fff':'#f5f6f7');
    const labelColor=pos.type==='bench'?'#b48a14':pos.type==='runner'?'#1a7a3a':'#25282a';
    let cells=`<td style="padding:4px 8px;font-weight:700;font-size:10px;color:${labelColor};background:${rowBg};border-bottom:1px solid #ddd;white-space:nowrap;">${pos.abbrev} &nbsp;${pos.label}</td>`;
    for(let i=0;i<numRot();i++){
      const cell=g[i][pos.key];let chips='';
      cell.players.forEach(p=>{chips+=`<span style="display:inline-block;padding:2px 6px;margin:1px;border:1px solid #9aa5b1;border-radius:3px;font-size:9px;font-weight:700;background:#e8edf2;color:#25282a;white-space:nowrap;">${p}</span>`;});
      cell.coaches.forEach(c=>{chips+=`<span style="display:inline-block;padding:2px 6px;margin:1px;border:1px solid #9b59b6;border-radius:3px;font-size:9px;font-weight:700;background:#f3e8ff;color:#7c3aad;white-space:nowrap;">ðŸ§¢ ${c.name||'Coach'}</span>`;});
      cells+=`<td style="padding:3px;text-align:center;background:${rowBg};border-bottom:1px solid #ddd;">${chips}</td>`;
    }
    tableRows+=`<tr>${cells}</tr>`;
  });

  let absentHtml=cur().absent.size>0?`<div style="font-size:9px;color:#cf3d3d;margin-bottom:4px;">ABSENT: ${[...cur().absent].join(', ')}</div>`:'';

  const enabledCoaches = DRILL_COACHES.filter(c => drillCoachEnabled[c.key]);
  let coachRows = enabledCoaches.map(c => {
    const name = drillCoachNames[c.key] || '';
    const nameCell = name
      ? `<td style="padding:3px 8px;font-size:10px;border-bottom:1px solid #ddd;">${name}</td>`
      : `<td style="padding:3px 8px;font-size:10px;border-bottom:1px solid #ddd;color:#bbb;">___________________</td>`;
    const optTag = c.required ? '' : ' <span style="color:#999;font-style:italic;">(optional)</span>';
    return `<tr><td style="padding:3px 8px;font-weight:700;font-size:10px;border-bottom:1px solid #ddd;">${c.role}${optTag}</td><td style="padding:3px 8px;font-size:10px;border-bottom:1px solid #ddd;">${c.desc}</td>${nameCell}</tr>`;
  }).join('');
  const html=`<!DOCTYPE html><html><head><title>Bronco Braves â€” 1st & 3rd Defense</title>
<style>@page{size:letter portrait;margin:0.4in;}@media print{body{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}}body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#111;font-size:11px;line-height:1.4;}h1{font-size:18px;font-weight:900;text-transform:uppercase;letter-spacing:2px;margin:0;}h1 span{font-weight:400;font-size:13px;color:#555;margin-left:8px;letter-spacing:0;}.date{font-size:9px;color:#777;}.sl{font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:1.5px;color:#111;border-bottom:2px solid #111;padding-bottom:2px;margin:10px 0 5px;}table{width:100%;border-collapse:collapse;margin-bottom:6px;}table.b{border:1px solid #bbb;}table.b td,table.b th{border:1px solid #ddd;}table.rot{border:1.5px solid #5b6770;}table.rot th,table.rot td{border-left:1px solid #ddd;}table.rot th:first-child,table.rot td:first-child{border-left:none;}th{font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:1px;padding:4px 8px;text-align:left;background:#f0f0f0;border-bottom:1px solid #bbb;}.g2{display:flex;gap:16px;}.g2>div{flex:1;}.sb{border:1px solid #ccc;border-radius:4px;padding:5px 8px;margin-bottom:4px;page-break-inside:avoid;}.st{font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;}.sb p{font-size:10px;margin:2px 0;}.sb strong{font-weight:800;}.hb{background:#f5f5f5;border-left:3px solid #333;padding:3px 8px;margin:3px 0;font-size:9px;}</style>
</head><body>
<div style="display:flex;justify-content:space-between;align-items:baseline;">
  <h1>BRONCO BRAVES <span>1st &amp; 3rd Defense â€” ${cur().name}</span></h1>
  <div style="text-align:right;"><div class="date">${today}</div><div style="font-size:9px;color:#555;">${ap.length} players Â· ${numRot()} rotations</div></div>
</div>
${absentHtml}
<div class="sl">COACHES</div>
<table class="b"><tr><th>Role</th><th>Responsibility</th><th>Name</th></tr>${coachRows}</table>
<div class="g2"><div>
  <div class="sl">SETUP</div>
  <table class="b">
    <tr><th style="width:28%;">Element</th><th>Details</th></tr>
    <tr><td style="padding:3px 8px;font-size:10px;font-weight:700;border-bottom:1px solid #ddd;">Coach</td><td style="padding:3px 8px;font-size:10px;border-bottom:1px solid #ddd;">Coach pitches from the mound to the catcher</td></tr>
    <tr><td style="padding:3px 8px;font-size:10px;font-weight:700;border-bottom:1px solid #ddd;">Runners</td><td style="padding:3px 8px;font-size:10px;border-bottom:1px solid #ddd;">Players line up at 1st and 3rd separately. Runner at 1st steals on the pitch.</td></tr>
    <tr><td style="padding:3px 8px;font-size:10px;font-weight:700;border-bottom:1px solid #ddd;">Rotation</td><td style="padding:3px 8px;font-size:10px;border-bottom:1px solid #ddd;">After a rep, runners swap â€” 1st line goes to 3rd line, 3rd goes to 1st.</td></tr>
    <tr><td style="padding:3px 8px;font-size:10px;font-weight:700;border-bottom:1px solid #ddd;">Defense</td><td style="padding:3px 8px;font-size:10px;border-bottom:1px solid #ddd;">Remaining players fill defensive positions. Rotate per schedule below.</td></tr>
  </table>
</div><div>
  <div class="sl">DEFENSIVE PLAYS</div>
  <div class="sb"><div class="st">Play 1: Throw Through to 2B</div><p>Runner at 1st steals. Catcher <strong>throws through to 2nd base</strong>. SS or 2B covers.</p><p>Runner at 3rd may try to score on the throw.</p></div>
  <div class="sb"><div class="st">Play 2: Catcher's Choice at 3B</div><p><strong>3B covers the bag.</strong> Catcher reads the runner at 3rd:</p><p>â€¢ <strong>Throw to 3B</strong> immediately</p><p>â€¢ <strong>Fake the throw</strong> to freeze the runner</p><p>â€¢ <strong>Hold the ball</strong> if the runner isn't going</p><div class="hb">Catcher makes the decision. Emphasize reading the runner at 3rd before committing.</div></div>
</div></div>
<div class="sl">ROTATIONS</div>
<table class="rot"><thead><tr>${headerCells}</tr></thead><tbody>${tableRows}</tbody></table>
<div class="sl">COACHING REMINDERS</div>
<div style="font-size:10px;">
  <p style="margin:2px 0;">â€¢ <strong>Catcher is the quarterback</strong> â€” every play starts with their read and decision.</p>
  <p style="margin:2px 0;">â€¢ 3B must get to the bag early on every rep â€” no lazy coverage.</p>
  <p style="margin:2px 0;">â€¢ Middle infielders communicate who covers 2nd before each pitch.</p>
  <p style="margin:2px 0;">â€¢ Runners at 3rd should vary aggressiveness to give the catcher different looks.</p>
  <p style="margin:2px 0;">â€¢ Keep reps moving â€” next pair steps on as soon as previous play is dead.</p>
</div>
</body></html>`;

  const w=window.open('','_blank');w.document.write(html);w.document.close();w.focus();setTimeout(()=>w.print(),400);
}

render();
</script>
</body>
</html>
